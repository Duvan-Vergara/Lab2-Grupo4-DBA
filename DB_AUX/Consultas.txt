-- 1. Buscar los 5 pedidos más cercanos a la empresa con id_empresa_asociada = id
SELECT 
    p.id_pedido,
    ST_Distance(
        ea.ubicacion_empresa_asociada::geography,
        p.ubicacion_entrega::geography
    ) AS distancia_metros
FROM 
    EMPRESA_ASOCIADA ea
JOIN 
    PEDIDO p ON TRUE
JOIN 
    DETALLE_PEDIDO dp ON p.id_detalle_pedido = dp.id_detalle_pedido
WHERE 
    ea.id_empresa_asociada = 2
    AND dp.entregado = false
ORDER BY 
    distancia_metros ASC
LIMIT 5;

-- 4. Identificar el punto de entrega más lejano desde cada empresa asociada.
SELECT 
  e.id_empresa_asociada,
  e.nombre AS empresa,
  p.id_pedido,
  ST_Distance(e.ubicacion_empresa_asociada, p.ubicacion_entrega) AS distancia
FROM EMPRESA_ASOCIADA e
JOIN PEDIDO p ON p.id_pedido = (
  SELECT p2.id_pedido
  FROM PEDIDO p2
  ORDER BY ST_Distance(e.ubicacion_empresa_asociada, p2.ubicacion_entrega) DESC
  LIMIT 1
);