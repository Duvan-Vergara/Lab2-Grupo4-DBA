-- 1. Buscar los 5 pedidos más cercanos a la empresa con id_empresa_asociada = id
SELECT 
    p.id_pedido,
    ST_Distance(
        ea.ubicacion_empresa_asociada::geography,
        p.ubicacion_entrega::geography
    ) AS distancia_metros
FROM 
    EMPRESA_ASOCIADA ea
JOIN 
    PEDIDO p ON TRUE
JOIN 
    DETALLE_PEDIDO dp ON p.id_detalle_pedido = dp.id_detalle_pedido
WHERE 
    ea.id_empresa_asociada = 2
    AND dp.entregado = false
ORDER BY 
    distancia_metros ASC
LIMIT 5;

-- 2. Determinar si un cliente se encuentra dentro de una zona de cobertura.
SELECT
  c.id_cliente,
  c.nombre,
  CASE
    WHEN ST_Within(c.ubicacion_cliente, z.zona_geom) THEN 'Dentro de la zona'
    ELSE 'Fuera de la zona'
  END AS estado
FROM cliente c
JOIN zona_cobertura z
  ON z.id_zona = 3

-- 4. Identificar el punto de entrega más lejano desde cada empresa asociada.
SELECT 
  e.id_empresa_asociada,
  e.nombre AS empresa,
  p.id_pedido,
  ST_Distance(e.ubicacion_empresa_asociada, p.ubicacion_entrega) AS distancia
FROM EMPRESA_ASOCIADA e
JOIN PEDIDO p ON p.id_pedido = (
  SELECT p2.id_pedido
  FROM PEDIDO p2
  ORDER BY ST_Distance(e.ubicacion_empresa_asociada, p2.ubicacion_entrega) DESC
  LIMIT 1
);

--6. Determinar los clientes que están a más de 5km de cualquier empresa o farmacia. (Como están las distancias en grados, 5 km ≈ 0.045 grados.

SELECT c.id_cliente, c.nombre
FROM cliente c
WHERE NOT EXISTS (
  SELECT 1
  FROM empresa_asociada e
  WHERE ST_Distance(c.ubicacion_cliente, e.ubicacion_empresa_asociada) <= 0.045
);